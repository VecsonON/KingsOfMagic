KoM_taoism_gain_progress_effect = {
	if = {
		limit = { NOT = { has_trait_with_flag = taoism_stage } }
		add_trait_force_tooltip = KoM_lianjing_huaqi
	}
	else = {
		switch = {
			trigger = has_trait
			KoM_lianjing_huaqi = {
				KoM_taoism_gain_progress_actual_effect = { TRAIT = lianjing_huaqi VALUE = $VALUE$ NEXT_TRAIT = KoM_lianqi_huashen }
			}
			KoM_lianqi_huashen = {
				KoM_taoism_gain_progress_actual_effect = { TRAIT = lianqi_huashen VALUE = $VALUE$ NEXT_TRAIT = KoM_lianshen_huanxu }
			}
			KoM_lianshen_huanxu = {
				KoM_taoism_gain_progress_actual_effect = { TRAIT = lianshen_huanxu VALUE = $VALUE$ NEXT_TRAIT = KoM_xian }
			}
		}
	}
}
KoM_taoism_gain_progress_actual_effect = {
	KoM_save_tooltip_custom = { NAME = saved_number LOC = $VALUE$ }
	KoM_save_tooltip = { LOC = KoM_$TRAIT$ }
	custom_tooltip = {
		text = KoM_taoism_gain_progress_actual_effect
		add_trait_xp = {
			trait = KoM_$TRAIT$
			value = $VALUE$
		}
	}
	save_scope_value_as = {
		name = total_xp
		value = {
			value = KoM_taoism_$TRAIT$_xp
			add = $VALUE$
			max = 100
		}
	}
	if = {
		limit = { scope:total_xp >= 100 }
		remove_trait = KoM_$TRAIT$
		add_trait_force_tooltip = $NEXT_TRAIT$
	}
}

KoM_the_neidan_meditation_effect = {
	custom_tooltip = KoM_the_neidan_meditation_effect
	save_scope_value_as = {
		name = xp_gained
		value = {
			value = KoM_taoism_xp
			if = { limit = { KoM_taoism_xp != 0 } divide = 50 }
			if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_meditation_spot } scope:building.var:building_level = 1 } multiply = 1.15 }
			if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_meditation_spot } scope:building.var:building_level = 2 } multiply = 1.3 }
			if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_meditation_spot } scope:building.var:building_level = 3 } multiply = 1.45 }
		}
	}
	send_interface_message = {
		title = KoM_rite_the_neidan_meditation
		KoM_taoism_gain_progress_effect = { VALUE = scope:xp_gained }
	}
	var:current_rite ?= {
		set_variable = {
			name = total_progress
			value = 0
		}
	}
	if = { limit = { has_trait = KoM_xian } trigger_event = { on_action = KoM_after_rite } }
}
KoM_qingqiu_huifu_yishi_effect = {
	save_scope_value_as = { name = scaling value = 0 }
	switch = {
		trigger = has_trait
		KoM_lianjing_huaqi = {
			save_scope_value_as = { name = scaling value = 1 }
			custom_tooltip = KoM_rite_qingqiu_huifu_yishi_lianjing_huaqi_effect
		}
		KoM_lianqi_huashen = {
			save_scope_value_as = { name = scaling value = 2 }
			custom_tooltip = KoM_rite_qingqiu_huifu_yishi_lianqi_huashen_effect
		}
		KoM_lianshen_huanxu = {
			save_scope_value_as = { name = scaling value = 3 }
			custom_tooltip = KoM_rite_qingqiu_huifu_yishi_lianshen_huanxu_effect
		}
		KoM_xian = {
			save_scope_value_as = { name = scaling value = 4 }
			custom_tooltip = KoM_rite_qingqiu_huifu_yishi_xian_effect
		}
	}
	$TARGET$ = {
		if = { limit = { has_trait = wounded_1 scope:scaling >= 1 } remove_trait = wounded_1 }
		if = { limit = { has_trait = scarred scope:scaling >= 1 } remove_trait = scarred }
		if = { limit = { has_trait = ill scope:scaling >= 1 } recover_from_disease_effect = { DISEASE = ill } }

		if = { limit = { has_trait = wounded_2 scope:scaling >= 2 } remove_trait = wounded_2 add_trait = wounded_1 }
		if = { limit = { has_trait = impotent scope:scaling >= 3 } remove_trait = impotent }
		if = { limit = { has_trait = disfigured scope:scaling >= 2 } remove_trait = disfigured }
		if = { limit = { has_trait = pneumonic scope:scaling >= 2 } recover_from_disease_effect = { DISEASE = pneumonic } }
		if = { limit = { has_trait = early_great_pox scope:scaling >= 2 } recover_from_disease_effect = { DISEASE = early_great_pox } }

		if = { limit = { has_trait = wounded_3 scope:scaling >= 3 } remove_trait = wounded_3 add_trait = wounded_2 }
		if = { limit = { has_trait = infirm scope:scaling >= 3 } remove_trait = infirm }
		if = { limit = { has_trait = consumption scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = consumption } }
		if = { limit = { has_trait = great_pox scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = great_pox } }
		if = { limit = { has_trait = gout_ridden scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = gout_ridden } }
		if = { limit = { has_trait = dysentery scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = dysentery } }
		if = { limit = { has_trait = leper scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = leper } }
		if = { limit = { has_trait = lovers_pox scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = lovers_pox } }
		if = { limit = { has_trait = ergotism scope:scaling >= 3 } recover_from_disease_effect = { DISEASE = ergotism } }

		if = { limit = { has_trait = maimed scope:scaling >= 4 } remove_trait = maimed }
		if = { limit = { has_trait = one_legged scope:scaling >= 4 } remove_trait = one_legged }
		if = { limit = { has_trait = eunuch_1 scope:scaling >= 4 } remove_trait = eunuch_1 }
		if = { limit = { has_trait = one_eyed scope:scaling >= 4 } remove_trait = one_eyed }
		if = { limit = { has_trait = blind scope:scaling >= 4 } remove_trait = blind add_trait = one_eyed }
		if = { limit = { has_trait = incapable scope:scaling >= 4 } remove_trait = incapable }
		if = { limit = { has_trait = cancer scope:scaling >= 4 } recover_from_disease_effect = { DISEASE = cancer } }
		if = { limit = { has_trait = smallpox scope:scaling >= 4 } recover_from_disease_effect = { DISEASE = smallpox } }
		if = { limit = { has_trait = typhus scope:scaling >= 4 } recover_from_disease_effect = { DISEASE = typhus } }
		if = { limit = { has_trait = bubonic_plague scope:scaling >= 4 } recover_from_disease_effect = { DISEASE = bubonic_plague } }
		if = { limit = { has_trait = measles scope:scaling >= 4 } recover_from_disease_effect = { DISEASE = measles } }

		KoM_remove_modifier_effect = { TYPE = character MODIFIER = infected_wound_modifier }
		KoM_remove_modifier_effect = { TYPE = character MODIFIER = gangrene_modifier }
		remove_disease_treatment_effect = yes
	}
	trigger_event = { on_action = KoM_after_rite }
}
KoM_qiqiu_pingjing_xinling_de_yishi_effect = {
	save_scope_value_as = { name = scaling value = 0 }
	switch = {
		trigger = has_trait
		KoM_lianjing_huaqi = { save_scope_value_as = { name = scaling value = 1 } }
		KoM_lianqi_huashen = {
			save_scope_value_as = { name = scaling value = 2 }
			custom_tooltip = KoM_rite_qiqiu_pingjing_xinling_de_yishi_lianqi_huashen_effect
		}
		KoM_lianshen_huanxu = {
			save_scope_value_as = { name = scaling value = 3 }
			custom_tooltip = KoM_rite_qiqiu_pingjing_xinling_de_yishi_lianshen_huanxu_effect
		}
		KoM_xian = {
			save_scope_value_as = { name = scaling value = 4 }
			custom_tooltip = KoM_rite_qiqiu_pingjing_xinling_de_yishi_xian_effect
		}
	}
	$TARGET$ = {
		switch = {
			trigger = scope:scaling
			1 = { add_character_modifier = { modifier = KoM_qiqiu_pingjing_xinling_de_yishi_lianjing_huaqi_modifier years = 5 } }
			2 = { add_character_modifier = { modifier = KoM_qiqiu_pingjing_xinling_de_yishi_lianqi_huashen_modifier years = 5 } }
			3 = { add_character_modifier = { modifier = KoM_qiqiu_pingjing_xinling_de_yishi_lianshen_huanxu_modifier years = 5 } }
			4 = { add_character_modifier = { modifier = KoM_qiqiu_pingjing_xinling_de_yishi_xian_modifier years = 5 } }
		}

		if = { limit = { has_trait = drunkard scope:scaling >= 2 } remove_trait = drunkard }
		if = { limit = { has_trait = hashishiyah scope:scaling >= 3 } remove_trait = hashishiyah }
		if = { limit = { has_trait = rakish scope:scaling >= 2 } remove_trait = rakish }
		if = { limit = { has_trait = inappetetic scope:scaling >= 2 } remove_trait = inappetetic }
		if = { limit = { has_trait = comfort_eater scope:scaling >= 2 } remove_trait = comfort_eater }

		if = { limit = { has_trait = irritable scope:scaling >= 3 } remove_trait = irritable }
		if = { limit = { has_trait = flagellant scope:scaling >= 3 } remove_trait = flagellant }
		if = { limit = { has_trait = profligate scope:scaling >= 3 } remove_trait = profligate }
		if = { limit = { has_trait = improvident scope:scaling >= 3 } remove_trait = improvident }

		if = { limit = { has_trait = reclusive scope:scaling >= 4 } remove_trait = reclusive }
		if = { limit = { has_trait = contrite scope:scaling >= 4 } remove_trait = contrite }
		if = { limit = { has_trait = depressed_1 scope:scaling >= 4 } remove_trait = depressed_1 }
		if = { limit = { has_trait = depressed_genetic scope:scaling >= 4 } remove_trait = depressed_genetic }
		if = { limit = { has_trait = lunatic_1 scope:scaling >= 4 } remove_trait = lunatic_1 }
		if = { limit = { has_trait = lunatic_genetic scope:scaling >= 4 } remove_trait = lunatic_genetic }
	}
	trigger_event = { on_action = KoM_after_rite }
}
KoM_qifu_yishi_effect = {
	switch = {
		trigger = has_trait
		KoM_lianjing_huaqi = { $TARGET$ = { add_character_modifier = { modifier = KoM_qifu_yishi_lianjing_huaqi_modifier years = 10 } } }
		KoM_lianqi_huashen = { $TARGET$ = { add_character_modifier = { modifier = KoM_qifu_yishi_lianqi_huashen_modifier years = 10 } } }
		KoM_lianshen_huanxu = { $TARGET$ = { add_character_modifier = { modifier = KoM_qifu_yishi_lianshen_huanxu_modifier years = 10 } } }
		KoM_xian = { $TARGET$ = { add_character_modifier = { modifier = KoM_qifu_yishi_xian_modifier years = 10 } } }
	}
	trigger_event = { on_action = KoM_after_rite }
}
KoM_qiqiu_mingri_zhishi_de_yishi_effect = {
	switch = {
		trigger = has_trait
		KoM_lianjing_huaqi = { $TARGET$ = { add_character_modifier = { modifier = KoM_qiqiu_mingri_zhishi_de_yishi_lianjing_huaqi_modifier years = 10 } } }
		KoM_lianqi_huashen = { $TARGET$ = { add_character_modifier = { modifier = KoM_qiqiu_mingri_zhishi_de_yishi_lianqi_huashen_modifier years = 10 } } }
		KoM_lianshen_huanxu = { $TARGET$ = { add_character_modifier = { modifier = KoM_qiqiu_mingri_zhishi_de_yishi_lianshen_huanxu_modifier years = 10 } } }
		KoM_xian = { $TARGET$ = { add_character_modifier = { modifier = KoM_qiqiu_mingri_zhishi_de_yishi_xian_modifier years = 10 } } }
	}
	save_scope_as = caster
	if = {
		limit = {
			OR = {
				has_trait = KoM_lianqi_huashen
				has_trait = KoM_lianshen_huanxu
				has_trait = KoM_xian
			}
		}
		custom_tooltip = KoM_rite_qiqiu_mingri_zhishi_de_yishi_lianqi_huashen_effect
		$TARGET$ = { every_scheme = { limit = { is_scheme_exposed = no } expose_scheme = scope:caster } }
	}
	if = {
		limit = {
			OR = {
				has_trait = KoM_lianshen_huanxu
				has_trait = KoM_xian
			}
		}
		custom_tooltip = KoM_rite_qiqiu_mingri_zhishi_de_yishi_lianshen_huanxu_effect
		$TARGET$ = { every_targeting_scheme = { limit = { is_scheme_exposed = no } expose_scheme = scope:caster } }
	}
	if = {
		limit = { has_trait = KoM_xian }
		custom_tooltip = KoM_rite_qiqiu_mingri_zhishi_de_yishi_xian_effect
		$TARGET$ = { every_targeting_scheme = { end_scheme = yes } }
	}
	trigger_event = { on_action = KoM_after_rite }
}
KoM_qingqiu_kuaisu_luxing_de_yishi_effect = {
	switch = {
		trigger = has_trait
		KoM_lianjing_huaqi = { add_character_modifier = { modifier = KoM_qingqiu_kuaisu_luxing_de_yishi_lianjing_huaqi_modifier years = 10 } }
		KoM_lianqi_huashen = { add_character_modifier = { modifier = KoM_qingqiu_kuaisu_luxing_de_yishi_lianqi_huashen_modifier years = 10 } }
		KoM_lianshen_huanxu = { add_character_modifier = { modifier = KoM_qingqiu_kuaisu_luxing_de_yishi_lianshen_huanxu_modifier years = 10 } }
		KoM_xian = { add_character_modifier = { modifier = KoM_qingqiu_kuaisu_luxing_de_yishi_xian_modifier years = 10 } }
	}
	trigger_event = { on_action = KoM_after_rite }
}