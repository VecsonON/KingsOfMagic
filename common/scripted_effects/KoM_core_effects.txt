KoM_create_grimoire_dev_effect = { #DEV
	KoM_create_grimoire_effect = {
		OWNER = THIS
		RARITY = illustrious
		NAME = grimoire_of_goetic_vecson
		SCHOOL = goetia
		MAX_MASTERY = 10
		MIN_MASTERY = 0
		MASTERY_GAIN = 100
	}
	KoM_create_grimoire_effect = {
		OWNER = THIS
		RARITY = illustrious
		NAME = grimoire_of_thaumaturgy_vecson
		SCHOOL = thaumaturgy
		MAX_MASTERY = 10
		MIN_MASTERY = 0
		MASTERY_GAIN = 100
	}
	KoM_create_grimoire_effect = {
		OWNER = THIS
		RARITY = illustrious
		NAME = grimoire_of_theurgy_vecson
		SCHOOL = theurgy
		MAX_MASTERY = 10
		MIN_MASTERY = 0
		MASTERY_GAIN = 100
	}
	KoM_create_grimoire_effect = {
		OWNER = THIS
		RARITY = illustrious
		NAME = grimoire_of_alchemy_vecson
		SCHOOL = alchemy
		MAX_MASTERY = 10
		MIN_MASTERY = 0
		MASTERY_GAIN = 100
	}
	KoM_create_grimoire_effect = {
		OWNER = THIS
		RARITY = illustrious
		NAME = grimoire_of_taoism_vecson
		SCHOOL = taoism
		MAX_MASTERY = 10
		MIN_MASTERY = 0
		MASTERY_GAIN = 100
	}
	KoM_create_grimoire_effect = {
		OWNER = THIS
		RARITY = illustrious
		NAME = grimoire_of_onmyodo_vecson
		SCHOOL = onmyodo
		MAX_MASTERY = 10
		MIN_MASTERY = 0
		MASTERY_GAIN = 100
	}
}

KoM_error_suppression_unused = {
	if = { limit = { always = no } if = { limit = { this = $VAR$ } } }
}
KoM_error_suppression_unused_flag = {
	KoM_error_suppression_unused = { VAR = flag:$FLAG$ }
}
KoM_save_tooltip_custom = {
	save_scope_value_as = { name = $NAME$ value = $LOC$ }
	KoM_error_suppression_unused = { VAR = $LOC$ }
}
KoM_save_tooltip = {
	KoM_save_tooltip_custom = { NAME = saved_tooltip LOC = flag:$LOC$ }
}
KoM_calculate_time_effect = {
	save_scope_value_as = {
		name = monthly_progress 
		value = {
			value = $MONTHLY_PROGRESS$
			multiply = KoM_extra_rite_speed_mult
		}
	}
	save_scope_value_as = {
		name = temp_years_calc
		value = {
			value = 100
			if = { limit = { $CURRENT_PROGRESS$ > 0 } subtract = $CURRENT_PROGRESS$ }
			divide = scope:monthly_progress
			divide = 12
			min = 0
		}
	}
	save_scope_value_as = {
		name = temp_months_calc
		value = {
			value = 100
			if = { limit = { $CURRENT_PROGRESS$ > 0 } subtract = $CURRENT_PROGRESS$ }
			divide = scope:monthly_progress
			modulo = 12
			min = 0
			add = 1
		}
	}
	if = {
		limit = { scope:temp_months_calc >= 12 }
		save_scope_value_as = {
			name = temp_months_calc
			value = {
				value = scope:temp_months_calc
				add = -12
			}
		}
		save_scope_value_as = {
			name = temp_years_calc
			value = {
				value = scope:temp_years_calc
				add = 1
			}
		}
	}
}
KoM_downgrade_relation_effect = {
	random_list = {
		1 = {
			trigger = {
				has_relation_best_friend = $CHARACTER$
			}
			remove_relation_best_friend = $CHARACTER$
			set_relation_friend = $CHARACTER$
		}
		1 = {
			trigger = {
				has_relation_soulmate = $CHARACTER$
			}
			remove_relation_soulmate = $CHARACTER$
			set_relation_lover = $CHARACTER$
		}
		1 = {
			trigger = {
				has_relation_nemesis = $CHARACTER$
			}
			remove_relation_nemesis = $CHARACTER$
			set_relation_rival = $CHARACTER$
		}

		1 = {
			trigger = {
				has_relation_friend = $CHARACTER$
				NOT = { has_relation_best_friend = $CHARACTER$ }
			}
			remove_relation_friend = $CHARACTER$
			set_relation_potential_friend = $CHARACTER$
		}
		1 = {
			trigger = {
				has_relation_lover = $CHARACTER$
				NOT = { has_relation_soulmate = $CHARACTER$ }
			}
			remove_relation_lover = $CHARACTER$
			set_relation_potential_lover = $CHARACTER$
		}
		1 = {
			trigger = {
				has_relation_rival = $CHARACTER$
				NOT = { has_relation_nemesis = $CHARACTER$ }
			}
			remove_relation_rival = $CHARACTER$
			set_relation_potential_rival = $CHARACTER$
		}
	}
}
KoM_remove_trait_effect = {
	if = {
		limit = { has_trait = $TRAIT$ }
		remove_trait = $TRAIT$
	}
}
KoM_remove_modifier_effect = {
	if = {
		limit = { has_$TYPE$_modifier = $MODIFIER$ }
		remove_$TYPE$_modifier = $MODIFIER$
	}
}
KoM_increase_or_set_variable_effect = {
	if = {
		limit = { has_variable = $VAR$ }
		change_variable = { name = $VAR$ add = $VAL$ }
	}
	else = {
		set_variable = { name = $VAR$ value = $VAL$ }
	}
}
KoM_give_modifier_times_keep_count_effect = {
	set_variable = {
		name = $VAR$
		value = 0
	}
	while = {
		count = $COUNT$
		add_$TYPE$_modifier = $MODIFIER$
	}
	KoM_increase_or_set_variable_effect = { VAR = $VAR$ VAL = $COUNT$ }
}
KoM_increase_durability_effect = {
	custom_description = {
		text = KoM_increase_durability_effect
		object = THIS
		value = $VALUE$
		set_max_durability = { value = { value = artifact_max_durability add = $VALUE$ } }
	}
}
KoM_give_positive_modifier_based_on_type = {
	switch = {
		trigger = artifact_slot_type
		helmet = { add_artifact_modifier = artifact_monthly_minor_prestige_4_modifier }
		primary_armament = { add_artifact_modifier = artifact_prowess_1_modifier }
		regalia = { add_artifact_modifier = artifact_vassal_limit_1_modifier }
		armor = { add_artifact_modifier = artifact_negate_prowess_penalty_add_1_modifier }
		miscellaneous = { add_artifact_modifier = artifact_monthly_minor_prestige_2_modifier }
		wall_big = { add_artifact_modifier = artifact_monthly_minor_prestige_4_modifier }
		wall_small = { add_artifact_modifier = artifact_monthly_minor_prestige_3_modifier }
		throne = { add_artifact_modifier = artifact_court_grandeur_baseline_add_2_modifier }
		sculpture = { add_artifact_modifier = artifact_court_grandeur_baseline_add_1_modifier }
		book = { add_artifact_modifier = artifact_monthly_lifestyle_xp_miniscule_modifier }
		pedestal = { add_artifact_modifier = artifact_court_grandeur_baseline_add_1_modifier }
		journal = { add_artifact_modifier = artifact_monthly_lifestyle_xp_miniscule_modifier }
		fallback = { }
	}
	custom_tooltip = KoM_give_modifier_based_on_type_tooltip
}
KoM_give_negative_modifier_based_on_type = {
	switch = {
		trigger = artifact_slot_type
		helmet = { add_artifact_modifier = artifact_monthly_minor_prestige_4_negative_modifier }
		primary_armament = { add_artifact_modifier = artifact_prowess_1_negative_modifier }
		regalia = { add_artifact_modifier = artifact_vassal_limit_1_negative_modifier }
		armor = { add_artifact_modifier = artifact_negate_prowess_penalty_add_1_negative_modifier }
		miscellaneous = { add_artifact_modifier = artifact_monthly_minor_prestige_2_negative_modifier }
		wall_big = { add_artifact_modifier = artifact_monthly_minor_prestige_4_negative_modifier }
		wall_small = { add_artifact_modifier = artifact_monthly_minor_prestige_3_negative_modifier }
		throne = { add_artifact_modifier = artifact_court_grandeur_baseline_add_2_negative_modifier }
		sculpture = { add_artifact_modifier = artifact_court_grandeur_baseline_add_1_negative_modifier }
		book = { add_artifact_modifier = artifact_monthly_lifestyle_xp_miniscule_negative_modifier }
		pedestal = { add_artifact_modifier = artifact_court_grandeur_baseline_add_1_negative_modifier }
		journal = { add_artifact_modifier = artifact_monthly_lifestyle_xp_miniscule_negative_modifier }
		fallback = { }
	}
	custom_tooltip = KoM_give_modifier_based_on_type_tooltip
}

KoM_create_grimoire_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_$RARITY$ = yes

	# Create the artifact
	create_artifact = {
		decaying = no
		name = KoM_artifact_$NAME$_name
		description = KoM_artifact_$NAME$_desc
		type = journal
		template = KoM_grimoire_template
		visuals = KoM_grimoire_visuals
		modifier = artifact_placeholder_modifier
		wealth = scope:wealth
		quality = scope:quality
		history = { type = created_before_history }
		save_scope_as = newly_created_artifact
	}
	hidden_effect_new_object = {
		scope:newly_created_artifact = {
			set_variable = { name = historical_unique_artifact value = yes }
			set_variable = {
				name = KoM_grimoire
				value = flag:$SCHOOL$
			}
			add_artifact_modifier = KoM_max_mastery_null_modifier
			KoM_give_modifier_times_keep_count_effect = {
				COUNT = $MAX_MASTERY$
				TYPE = artifact
				MODIFIER = KoM_max_mastery_modifier
				VAR = max_mastery
			}
			add_artifact_modifier = KoM_min_mastery_null_modifier
			KoM_give_modifier_times_keep_count_effect = {
				COUNT = $MIN_MASTERY$
				TYPE = artifact
				MODIFIER = KoM_min_mastery_modifier
				VAR = min_mastery
			}
			add_artifact_modifier = KoM_mastery_gain_null_modifier
			KoM_give_modifier_times_keep_count_effect = {
				COUNT = $MASTERY_GAIN$
				TYPE = artifact
				MODIFIER = KoM_mastery_gain_modifier
				VAR = mastery_gain
			}
		}
	}
}


KoM_study_magic_school_effect = {
	switch = {
		trigger = $SCHOOL$
		flag:goetia = { trait:KoM_magus = { save_scope_as = trait } }
		flag:thaumaturgy = { trait:KoM_thaumaturge = { save_scope_as = trait } }
		flag:theurgy = { trait:KoM_theurgist = { save_scope_as = trait } }
		flag:alchemy = { trait:KoM_alchemist = { save_scope_as = trait } }
		flag:taoism = { trait:KoM_daoshi = { save_scope_as = trait } }
		flag:onmyodo = { trait:KoM_onmyoji = { save_scope_as = trait } }
	}
	if = {
		limit = {
			NOT = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = $SCHOOL$ } }
		}
		KoM_learn_magic_school_from_trait_effect = { TRAIT = scope:trait }
	}
	else_if = {
		limit = { has_trait = scope:trait }
		send_interface_toast = {
			type = event_toast_effect_neutral
			title = KoM_study_magic_school_effect
			add_trait_xp = {
				trait = scope:trait
				value = $COUNT$
			}
		}
	}
	else = {
		send_interface_toast = {
			type = event_toast_effect_neutral
			title = KoM_study_magic_school_effect
			KoM_add_hidden_magic_school_xp_effect = { TRAIT = scope:trait COUNT = $COUNT$ }
		}
	}
}
KoM_add_hidden_magic_school_xp_effect = {
	custom_description = {
		text = KoM_add_magic_school_xp
		object = $TRAIT$
		value = $COUNT$
		switch = {
			trigger = $TRAIT$
			trait:KoM_magus = { 
				change_variable = { name = KoM_goetia_xp add = $COUNT$ } 
				set_variable = { name = KoM_goetia_xp value = { value = KoM_goetia_xp max = 100 } }
			}
			trait:KoM_thaumaturge = { 
				change_variable = { name = KoM_thaumaturgy_xp add = $COUNT$ } 
				set_variable = { name = KoM_thaumaturgy_xp value = { value = KoM_thaumaturgy_xp max = 100 } }
			}
			trait:KoM_theurgist = { 
				change_variable = { name = KoM_theurgy_xp add = $COUNT$ } 
				set_variable = { name = KoM_theurgy_xp value = { value = KoM_theurgy_xp max = 100 } }
			}
			trait:KoM_alchemist = { 
				change_variable = { name = KoM_alchemy_xp add = $COUNT$ } 
				set_variable = { name = KoM_alchemy_xp value = { value = KoM_alchemy_xp max = 100 } }
			}
			trait:KoM_daoshi = { 
				change_variable = { name = KoM_taoism_xp add = $COUNT$ } 
				set_variable = { name = KoM_taoism_xp value = { value = KoM_taoism_xp max = 100 } }
			}
			trait:KoM_onmyoji = { 
				change_variable = { name = KoM_onmyodo_xp add = $COUNT$ } 
				set_variable = { name = KoM_onmyodo_xp value = { value = KoM_onmyodo_xp max = 100 } }
			}
		}
	}
}
KoM_learn_magic_school_from_trait_effect = {
	send_interface_toast = {
		type = event_toast_effect_neutral
		title = KoM_learn_magic_school_from_trait_effect
		switch = {
			trigger = $TRAIT$
			trait:KoM_magus = {
				set_variable = { name = KoM_goetia_xp value = 0 }
				add_secret = { TYPE = KoM_secret_magus }
			}
			trait:KoM_thaumaturge = {
				set_variable = { name = KoM_thaumaturgy_xp value = 0 }
				add_secret = { TYPE = KoM_secret_thaumaturge }
			}
			trait:KoM_theurgist = {
				set_variable = { name = KoM_theurgy_xp value = 0 }
				add_secret = { TYPE = KoM_secret_theurgist }
			}
			trait:KoM_alchemist = {
				set_variable = { name = KoM_alchemy_xp value = 0 }
				add_secret = { TYPE = KoM_secret_alchemist }
			}
			trait:KoM_daoshi = {
				set_variable = { name = KoM_taoism_xp value = 0 }
				add_secret = { TYPE = KoM_secret_daoshi }
			}
			trait:KoM_onmyoji = {
				set_variable = { name = KoM_onmyodo_xp value = 0 }
				add_secret = { TYPE = KoM_secret_onmyoji }
			}
		}
	}
}


KoM_start_rite_effect = {
	KoM_save_tooltip = { LOC = $ID$ }
	KoM_calculate_time_effect = { MONTHLY_PROGRESS = $MONTHLY_PROGRESS$ CURRENT_PROGRESS = 0 }
	custom_tooltip = {
		text = KoM_start_rite_effect
		create_story = {
			type = KoM_story_cycle
			save_scope_as = temp_rite
		}
		hidden_effect_new_object = {
			scope:temp_rite = {
				set_variable = {
					name = id
					value = flag:$ID$
				}
				set_variable = {
					name = monthly_progress
					value = $MONTHLY_PROGRESS$
				}
				set_variable = {
					name = target
					value = $TARGET$
				}
				set_variable = {
					name = school
					value = flag:$SCHOOL$
				}
				if = { limit = { var:school ?= flag:$SCHOOL$ } }
			}
		}
		set_variable = {
			name = current_rite
			value = scope:temp_rite
		}
	}
}
ALT_delete_rite_effect = {
	$RITE$ = { save_scope_as = rite }
	remove_variable = current_rite
	scope:rite = { end_story = yes }
}

KoM_teach_magic_effect = {
	save_scope_value_as = {
		name = xp_gained
		value = {
			value = $TEACHER$.learning
			divide = 5
		}
	}
	if = {
		limit = {
			save_temporary_scope_value_as = {
				name = total_xp_after
				value = {
					value = $STUDENT$.KoM_$SCHOOL$_xp
					add = scope:xp_gained
				}
			}
			scope:total_xp_after > $TEACHER$.KoM_$SCHOOL$_xp
		}
		save_scope_value_as = {
			name = xp_gained
			value = {
				value = scope:xp_gained
				add = {
					value = scope:total_xp_after
					add = {
						value = $TEACHER$.KoM_$SCHOOL$_xp
						multiply = -1
					}
					multiply = -1
				}
			}
		}
	}
	KoM_study_magic_school_effect = { SCHOOL = flag:$SCHOOL$ COUNT = scope:xp_gained }
	switch = {
		trigger = flag:$SCHOOL$
		flag:goetia = { 
			every_secret = {
				limit = { secret_type = KoM_secret_magus }
				reveal_to = $TEACHER$
			}
		}
		flag:thaumaturgy = { 
			every_secret = {
				limit = { secret_type = KoM_secret_thaumaturge }
				reveal_to = $TEACHER$
			}
		}
		flag:theurgy = { 
			every_secret = {
				limit = { secret_type = KoM_secret_theurgist }
				reveal_to = $TEACHER$
			}
		}
		flag:alchemy = { 
			every_secret = {
				limit = { secret_type = KoM_secret_alchemist }
				reveal_to = $TEACHER$
			}
		}
		flag:taoism = { 
			every_secret = {
				limit = { secret_type = KoM_secret_daoshi }
				reveal_to = $TEACHER$
			}
		}
		flag:onmyodo = { 
			every_secret = {
				limit = { secret_type = KoM_secret_onmyoji }
				reveal_to = $TEACHER$
			}
		}
	}
}