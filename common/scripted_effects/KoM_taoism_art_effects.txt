KoM_taoism_gain_progress_effect = {
	if = {
		limit = { NOT = { has_trait_with_flag = taoism_stage } }
		add_trait_force_tooltip = KoM_lianjing_huaqi
	}
	else = {
		switch = {
			trigger = has_trait
			KoM_lianjing_huaqi = {
				KoM_taoism_gain_progress_actual_effect = { TRAIT = lianjing_huaqi VALUE = $VALUE$ NEXT_TRAIT = KoM_lianqi_huashen }
			}
			KoM_lianqi_huashen = {
				KoM_taoism_gain_progress_actual_effect = { TRAIT = lianqi_huashen VALUE = $VALUE$ NEXT_TRAIT = KoM_lianshen_huanxu }
			}
			KoM_lianshen_huanxu = {
				KoM_taoism_gain_progress_actual_effect = { TRAIT = lianshen_huanxu VALUE = $VALUE$ NEXT_TRAIT = KoM_xian }
			}
		}
	}
}
KoM_taoism_gain_progress_actual_effect = {
	KoM_save_tooltip_custom = { NAME = saved_number LOC = $VALUE$ }
	KoM_save_tooltip = { LOC = KoM_$TRAIT$ }
	custom_tooltip = {
		text = KoM_taoism_gain_progress_actual_effect
		add_trait_xp = {
			trait = KoM_$TRAIT$
			value = $VALUE$
		}
	}
	save_scope_value_as = {
		name = total_xp
		value = {
			value = KoM_taoism_$TRAIT$_xp
			add = $VALUE$
			max = 100
		}
	}
	if = {
		limit = { scope:total_xp >= 100 }
		remove_trait = KoM_$TRAIT$
		add_trait_force_tooltip = $NEXT_TRAIT$
	}
}

KoM_the_neidan_meditation_effect = {
	custom_tooltip = KoM_the_neidan_meditation_effect
	save_scope_value_as = {
		name = xp_gained
		value = {
			value = KoM_taoism_xp
			if = { limit = { KoM_taoism_xp != 0 } divide = 50 }
		}
	}
	send_interface_message = {
		title = KoM_rite_the_neidan_meditation
		KoM_taoism_gain_progress_effect = { VALUE = scope:xp_gained }
	}
	var:current_rite ?= {
		set_variable = {
			name = total_progress
			value = 0
		}
	}
}