KoM_window_script = {
	effect = {
		KoM_calculate_time_effect = { MONTHLY_PROGRESS = var:current_rite.var:monthly_progress CURRENT_PROGRESS = var:current_rite.var:total_progress }
		custom_tooltip = WINDOW_KOM_TT_TIME
	}
}
KoM_window_cancel = {
	effect = {
		ALT_delete_rite_effect = { RITE = var:current_rite }
	}
}


###

KoM_spell_creator_open = {
	effect = {
		clear_variable_list = KoM_spell_creator_declarations
		clear_variable_list = KoM_spell_creator_confirmations
		clear_variable_list = KoM_spell_creator_spell_actions

		if = {
			limit = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = 10 AT_LEAST = yes } }
			add_to_variable_list = { name = KoM_spell_creator_declarations target = flag:persona }
			add_to_variable_list = { name = KoM_spell_creator_confirmations target = flag:voluntas }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:recuperare }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:claritudo }
		}
		if = {
			limit = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = 30 AT_LEAST = yes } }
			add_to_variable_list = { name = KoM_spell_creator_declarations target = flag:res }
			add_to_variable_list = { name = KoM_spell_creator_confirmations target = flag:nuntius }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:sarcio }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:damnum }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:celeritas }
		}
		if = {
			limit = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = 50 AT_LEAST = yes } }
			add_to_variable_list = { name = KoM_spell_creator_confirmations target = flag:angelus }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:duo }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:fortitudo }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:stabilitas }
		}
		if = {
			limit = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = 75 AT_LEAST = yes } }
			add_to_variable_list = { name = KoM_spell_creator_declarations target = flag:locus }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:opinio }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:anima }
		}
		if = {
			limit = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = 100 AT_LEAST = yes } }
			add_to_variable_list = { name = KoM_spell_creator_confirmations target = flag:deus }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:tres }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:scientia }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:melius }
			add_to_variable_list = { name = KoM_spell_creator_spell_actions target = flag:peius }
		}




		KoM_create_empty_spell_effect = yes
		set_variable = {
			name = KoM_spell_creator_spell
			value = scope:temp_spell
		}
	}
}
KoM_spell_creator_close = {
	effect = {
		clear_variable_list = KoM_spell_creator_declarations
		clear_variable_list = KoM_spell_creator_confirmations
		clear_variable_list = KoM_spell_creator_spell_actions
		remove_variable = KoM_spell_creator_spell
		remove_variable = KoM_spell_creator_open
	}
}

KoM_spell_creator_select_declaration = {
	effect = { KoM_select_spell_declaration_effect = { SPELL = var:KoM_spell_creator_spell DECLARATION = scope:declaration } }
}

KoM_spell_creator_select_confirmation = {
	effect = { KoM_select_spell_confirmation_effect = { SPELL = var:KoM_spell_creator_spell CONFIRMATION = scope:confirmation } }
}

KoM_spell_creator_add_spell_action = {
	is_valid = {
		save_temporary_scope_value_as = {
			name = num_of_actions
			value = {
				value = 0
				var:KoM_spell_creator_spell = { 
					every_in_list = {
						variable = spell_actions
						add = 1
					}
				}
			}
		}
		save_temporary_scope_value_as = {
			name = max_actions
			value = {
				value = 1
				if = {
					limit = {
						var:KoM_spell_creator_spell = {
							any_in_list = {
								variable = spell_actions
								var:action_name = flag:duo
							}
						} 
					}
					add = 2
				}
				else_if = {
					limit = {
						var:KoM_spell_creator_spell = {
							any_in_list = {
								variable = spell_actions
								var:action_name = flag:tres
							}
						} 
					}
					add = 3
				}

			}
		}
		custom_tooltip = {
			text = KoM_spell_creator_add_spell_action_max
			scope:max_actions > scope:num_of_actions
		}
		custom_tooltip = {
			text = KoM_spell_creator_add_spell_action_incompatible_actions
			trigger_if = {
				limit = { scope:spell_action = flag:duo }
				var:KoM_spell_creator_spell = {
					NOT = {
						any_in_list = {
							variable = spell_actions
							var:action_name = flag:tres
						}
					}
					NOT = {
						any_in_list = {
							variable = spell_actions
							var:action_name = flag:duo
						}
					}
				}
			}
			trigger_if = {
				limit = { scope:spell_action = flag:tres }
				var:KoM_spell_creator_spell = {
					NOT = {
						any_in_list = {
							variable = spell_actions
							var:action_name = flag:duo
						}
					}
					NOT = {
						any_in_list = {
							variable = spell_actions
							var:action_name = flag:tres
						}
					}
				}
			}
		}
	}
	effect = { KoM_add_spell_action_effect = { SPELL = var:KoM_spell_creator_spell SPELL_ACTION = scope:spell_action } }
}

KoM_spell_creator_preview = {
	effect = { 
		if = {
			limit = { var:KoM_spell_creator_spell.var:declaration ?= flag:persona }
			save_scope_as = spell_target
		}
		if = {
			limit = { var:KoM_spell_creator_spell.var:declaration ?= flag:res }
			if = {
				limit = { has_any_artifact = yes }
				random_character_artifact = { save_scope_as = spell_target }
			}
			else = {
				random_artifact = { save_scope_as = spell_target }
			}
		}
		if = {
			limit = { var:KoM_spell_creator_spell.var:declaration ?= flag:locus }
			location = {
				county = { save_scope_as = spell_target }
			}
		}
		KoM_execute_spell_effect = { TARGET = scope:spell_target SPELL = var:KoM_spell_creator_spell } 
	}
}

KoM_spell_creator_clear_spell_actions = {
	effect = {
		var:KoM_spell_creator_spell ?= { clear_variable_list = spell_actions }
	}
}

KoM_spell_creator_rename_spell = {
	effect = {
		trigger_event = KoM_thaumaturgy_events.1
	}
}

KoM_finish_spell = {
	is_valid = {
		custom_tooltip = {
			text = KoM_finish_spell_need_declaration
			var:KoM_spell_creator_spell ?= { has_variable = declaration }
		}
		custom_tooltip = {
			text = KoM_finish_spell_need_confirmation
			var:KoM_spell_creator_spell ?= { has_variable = confirmation }
		}
		custom_tooltip = {
			text = KoM_finish_spell_need_spell_actions
			var:KoM_spell_creator_spell ?= { has_variable_list = spell_actions }
		}
	}
	effect = {
		KoM_start_rite_effect = {
			ID = thaumaturgy_spell_creation
			MONTHLY_PROGRESS = KoM_rite_time_1_year
			TARGET = ROOT
			SCHOOL = thaumaturgy
		}
		var:current_rite ?= { set_variable = { name = spell value = PREV.var:KoM_spell_creator_spell } }
	}
}