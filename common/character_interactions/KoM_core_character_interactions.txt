KoM_study_grimoire_interaction = {
	category = interaction_category_friendly
	icon = icon_scheme_crypto_religion
	desc = KoM_study_grimoire_interaction_desc

	target_type = artifact
	target_filter = actor_artifacts

	ai_frequency = 60
	ai_will_do = {
		base = 1

		modifier = {
			add = 10
			scope:actor = { has_trait = scholar }
		}
		modifier = {
			add = 20
			scope:actor = { has_trait = witch }
		}
		modifier = {
			add = scope:actor.age
		}

		modifier = {
			add = -20
			scope:actor = { 
				faith = { has_doctrine_parameter = witchcraft_illegal }
				NOT = { has_trait = cynical }
			}
		}
		modifier = {
			add = -10
			scope:actor = { 
				faith = { has_doctrine_parameter = witchcraft_shunned }
				NOT = { has_trait = cynical }
			}
		}
	}
	ai_targets = { ai_recipients = self }

	cooldown = { years = 2 }

	is_shown = {
		scope:actor = scope:recipient
		scope:actor = {
			any_character_artifact = {
				has_variable = KoM_grimoire
			}
		}
	}

	can_be_picked_artifact = {
		scope:target = {
			custom_tooltip = {
				text = KoM_study_grimoire_interaction_tt
				has_variable = KoM_grimoire
			}
		}
	}

	is_valid_showing_failures_only = {
		trigger_if = {
			limit = { exists = scope:target scope:target ?= { has_variable = KoM_grimoire } }
			scope:actor = {
				KoM_has_magic_school_xp_trigger = { SCHOOL = scope:target.var:KoM_grimoire VALUE = scope:target.var:max_mastery AT_LEAST = no } 
				KoM_has_magic_school_xp_trigger = { SCHOOL = scope:target.var:KoM_grimoire VALUE = scope:target.var:min_mastery AT_LEAST = yes }
				learning >= 8
			}
		}
	}

	on_accept = {
		scope:actor = {
			duel = {
				skill = learning
				value = 10
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = high_positive_duel_skill_multiplier
					}
					KoM_study_magic_school_effect = { SCHOOL = scope:target.var:KoM_grimoire COUNT = scope:target.var:mastery_gain }
				}
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = low_negative_duel_skill_multiplier
					}
					add_stress = 25
				}
			}
			if = {
				limit = { 
					scope:target = { has_variable = gained_via_decision } 
					switch = {
						trigger = scope:target.var:KoM_grimoire
						flag:goetia = { has_variable = KoM_goetia_xp }
						flag:thaumaturgy = { has_variable = KoM_thaumaturgy_xp }
						flag:theurgy = { has_variable = KoM_theurgy_xp }
						flag:alchemy = { has_variable = KoM_alchemy_xp }
						flag:taoism = { has_variable = KoM_taoism_xp }
						flag:onmyodo = { has_variable = KoM_onmyodo_xp }
					}
					KoM_is_a_mage_trigger = yes
				}
				custom_tooltip = KoM_study_grimoire_interaction_warning
				hidden_effect = {
					random = {
						chance = 20
						send_interface_message = {
							title = KoM_study_grimoire_interaction
							switch = {
								trigger = scope:target.var:KoM_grimoire
								flag:goetia = {
									random_secret = {
										limit = { secret_type = KoM_secret_magus }
										expose_secret = scope:actor
									}
								}
								flag:thaumaturgy = {
									random_secret = {
										limit = { secret_type = KoM_secret_thaumaturge }
										expose_secret = scope:actor
									}
								}
								flag:theurgy = {
									random_secret = {
										limit = { secret_type = KoM_secret_theurgist }
										expose_secret = scope:actor
									}
								}
								flag:alchemy = {
									random_secret = {
										limit = { secret_type = KoM_secret_alchemist }
										expose_secret = scope:actor
									}
								}
								flag:taoism = {
									random_secret = {
										limit = { secret_type = KoM_secret_daoshi }
										expose_secret = scope:actor
									}
								}
								flag:onmyodo = {
									random_secret = {
										limit = { secret_type = KoM_secret_onmyoji }
										expose_secret = scope:actor
									}
								}
							}
						}
					}
				}
			}
		}
	}

	auto_accept = yes
}

KoM_teach_magic_interaction = {
	category = interaction_category_friendly
	icon = icon_scheme_crypto_religion
	desc = KoM_teach_magic_interaction_desc

	is_shown = {
		NOT = { scope:actor = scope:recipient }
		scope:actor = { KoM_is_a_mage_trigger = yes }
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:goetia } } }
		is_valid = { scope:recipient = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:goetia VALUE = scope:actor.KoM_goetia_xp AT_LEAST = no } } }
		flag = goetia
		localization = KoM_goetia
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:thaumaturgy } } }
		is_valid = { scope:recipient = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = scope:actor.KoM_thaumaturgy_xp AT_LEAST = no } } }
		flag = thaumaturgy
		localization = KoM_thaumaturgy
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:theurgy } } }
		is_valid = { scope:recipient = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:theurgy VALUE = scope:actor.KoM_theurgy_xp AT_LEAST = no } } }
		flag = theurgy
		localization = KoM_theurgy
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:alchemy } } }
		is_valid = { scope:recipient = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:alchemy VALUE = scope:actor.KoM_alchemy_xp AT_LEAST = no } } }
		flag = alchemy
		localization = KoM_alchemy
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:taoism } } }
		is_valid = { scope:recipient = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:taoism VALUE = scope:actor.KoM_taoism_xp AT_LEAST = no } } }
		flag = taoism
		localization = KoM_taoism
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:onmyodo } } }
		is_valid = { scope:recipient = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:onmyodo VALUE = scope:actor.KoM_onmyodo_xp AT_LEAST = no } } }
		flag = onmyodo
		localization = KoM_onmyodo
	}

	on_accept = {
		scope:actor = {
			custom_tooltip = KoM_teach_magic_interaction_info
		}
		scope:recipient = {
			duel = {
				skill = learning
				value = 15
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = high_positive_duel_skill_multiplier
					}
					modifier = {
						add = scope:actor.learning
					}
					switch = {
						trigger = yes
						scope:goetia = { KoM_teach_magic_effect = { SCHOOL = goetia STUDENT = scope:recipient TEACHER = scope:actor } }
						scope:thaumaturgy = { KoM_teach_magic_effect = { SCHOOL = thaumaturgy STUDENT = scope:recipient TEACHER = scope:actor } }
						scope:theurgy = { KoM_teach_magic_effect = { SCHOOL = theurgy STUDENT = scope:recipient TEACHER = scope:actor } }
						scope:alchemy = { KoM_teach_magic_effect = { SCHOOL = alchemy STUDENT = scope:recipient TEACHER = scope:actor } }
						scope:taoism = { KoM_teach_magic_effect = { SCHOOL = taoism STUDENT = scope:recipient TEACHER = scope:actor } }
						scope:onmyodo = { KoM_teach_magic_effect = { SCHOOL = onmyodo STUDENT = scope:recipient TEACHER = scope:actor } }
						fallback = { custom_tooltip = KoM_teach_magic_interaction_warning }
					}
				}
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = low_negative_duel_skill_multiplier
					}
					modifier = {
						add = {
							value = scope:actor.learning
							multiply = -1
						}
					}
					send_interface_message = {
						title = KoM_teach_magic_interaction
						add_stress = 25
					}
				}
			}
		}
	}

	ai_frequency = 60
	ai_will_do = { 
		base = -45
		opinion_modifier = {
			who = scope:actor
			opinion_target = scope:recipient
			multiplier = 0.5
		}
		compatibility_modifier = {
			who = scope:actor
			compatibility_target = scope:recipient
			multiplier = 0.2
		}
		opinion_modifier = {
			who = scope:recipient
			opinion_target = scope:actor
			multiplier = 0.5
		}
		ai_value_modifier = {
			who = scope:recipient
			ai_honor = 0.2
			ai_compassion = 0.1
			ai_rationality = 0.2
			ai_greed = 0.2
			ai_sociability = 0.1
		}
		ai_value_modifier = {
			trigger = {
				OR = {
					scope:recipient.faith = { has_doctrine_parameter = witchcraft_illegal }
					scope:recipient.faith = { has_doctrine_parameter = witchcraft_shunned }
				}
			}
			ai_zeal = -0.5
			max = 20
		}

		# Are they important (to me)
		modifier = {
			add = {
				value = scope:recipient.highest_held_title_tier
				subtract = scope:actor.highest_held_title_tier
				multiply = 10
			}
		}
		modifier = {
			OR = {
				is_close_family_of = scope:recipient
				is_consort_of = scope:recipient
				has_relation_lover = scope:recipient
				has_relation_friend = scope:recipient
			}
			add = 20
		}
		modifier = {
			OR = {
				has_relation_best_friend = scope:recipient
				has_relation_soulmate = scope:recipient
			}
			add = 30
		}
		modifier = {
			exists = house
			exists = scope:recipient.house
			house = scope:recipient.house
			add = 10
		}

		# Do I want to spread the word
		ai_value_modifier = {
			ai_sociability = 0.2
			ai_compassion = 0.1
			ai_boldness = 0.4
			min = -20
		}
	}
	ai_targets = { 
		ai_recipients = family 
		ai_recipients = scripted_relations 
		max = 10 
	}
	ai_accept = {
		base = 0
		
		modifier = {
			scope:recipient.faith = { has_doctrine_parameter = witchcraft_illegal }
			OR = {
				scope:goetia = yes
				scope:thaumaturgy = yes
				scope:alchemy = yes
			}
			add = -40
		}
		modifier = {
			scope:recipient.faith = { has_doctrine_parameter = witchcraft_shunned }
			OR = {
				scope:goetia = yes
				scope:thaumaturgy = yes
				scope:alchemy = yes
			}
			add = -20
		}

		opinion_modifier = {
			who = scope:recipient
			opinion_target = scope:actor
			multiplier = 0.5
			desc = AI_OPINION_REASON
		}

		modifier = {
			add = 10
			desc = ai_acceptance_trait_ambitious
			scope:recipient = { has_trait = ambitious }
		}

		modifier = {
			add = 10
			desc = ai_acceptance_trait_cynical
			scope:recipient = { has_trait = cynical }
		}

		modifier = {
			add = 10
			desc = ai_acceptance_trait_scholar
			scope:recipient = { has_trait = scholar }
		}
	}
}

KoM_request_teaching_interaction = {
	category = interaction_category_friendly
	icon = icon_scheme_crypto_religion
	desc = KoM_teach_magic_interaction_desc

	is_shown = {
		NOT = { scope:actor = scope:recipient }
		scope:recipient = { 
			# KoM_is_a_mage_trigger = yes # As this would also show it for secret mages
			OR = {
				has_trait_with_flag = mage
				scope:actor = {
					any_known_secret = {
						secret_owner = scope:recipient
						OR = {
							secret_type = KoM_secret_magus
							secret_type = KoM_secret_thaumaturge
							secret_type = KoM_secret_theurgist
							secret_type = KoM_secret_alchemist
							secret_type = KoM_secret_daoshi
							secret_type = KoM_secret_onmyoji
						}
					}
				}
			}
		}
	}

	send_option = {
		is_shown = { scope:recipient = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:goetia } } }
		is_valid = { scope:actor = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:goetia VALUE = scope:recipient.KoM_goetia_xp AT_LEAST = no } } }
		flag = goetia
		localization = KoM_goetia
	}

	send_option = {
		is_shown = { scope:recipient = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:thaumaturgy } } }
		is_valid = { scope:actor = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:thaumaturgy VALUE = scope:recipient.KoM_thaumaturgy_xp AT_LEAST = no } } }
		flag = thaumaturgy
		localization = KoM_thaumaturgy
	}

	send_option = {
		is_shown = { scope:recipient = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:theurgy } } }
		is_valid = { scope:actor = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:theurgy VALUE = scope:recipient.KoM_theurgy_xp AT_LEAST = no } } }
		flag = theurgy
		localization = KoM_theurgy
	}

	send_option = {
		is_shown = { scope:recipient = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:alchemy } } }
		is_valid = { scope:actor = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:alchemy VALUE = scope:recipient.KoM_alchemy_xp AT_LEAST = no } } }
		flag = alchemy
		localization = KoM_alchemy
	}

	send_option = {
		is_shown = { scope:recipient = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:taoism } } }
		is_valid = { scope:actor = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:taoism VALUE = scope:recipient.KoM_taoism_xp AT_LEAST = no } } }
		flag = taoism
		localization = KoM_taoism
	}

	send_option = {
		is_shown = { scope:recipient = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:onmyodo } } }
		is_valid = { scope:actor = { KoM_has_magic_school_xp_trigger = { SCHOOL = flag:onmyodo VALUE = scope:recipient.KoM_onmyodo_xp AT_LEAST = no } } }
		flag = onmyodo
		localization = KoM_onmyodo
	}

	on_accept = {
		scope:recipient = {
			custom_tooltip = KoM_request_teaching_interaction_info
		}
		scope:actor = {
			duel = {
				skill = learning
				value = 15
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = high_positive_duel_skill_multiplier
					}
					modifier = {
						add = scope:recipient.learning
					}
					switch = {
						trigger = yes
						scope:goetia = { KoM_teach_magic_effect = { SCHOOL = goetia STUDENT = scope:actor TEACHER = scope:recipient } }
						scope:thaumaturgy = { KoM_teach_magic_effect = { SCHOOL = thaumaturgy STUDENT = scope:actor TEACHER = scope:recipient } }
						scope:theurgy = { KoM_teach_magic_effect = { SCHOOL = theurgy STUDENT = scope:actor TEACHER = scope:recipient } }
						scope:alchemy = { KoM_teach_magic_effect = { SCHOOL = alchemy STUDENT = scope:actor TEACHER = scope:recipient } }
						scope:taoism = { KoM_teach_magic_effect = { SCHOOL = taoism STUDENT = scope:actor TEACHER = scope:recipient } }
						scope:onmyodo = { KoM_teach_magic_effect = { SCHOOL = onmyodo STUDENT = scope:actor TEACHER = scope:recipient } }
						fallback = { custom_tooltip = KoM_teach_magic_interaction_warning }
					}
				}
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = low_negative_duel_skill_multiplier
					}
					modifier = {
						add = {
							value = scope:recipient.learning
							multiply = -1
						}
					}
					send_interface_message = {
						title = KoM_teach_magic_interaction
						add_stress = 25
					}
				}
			}
		}
	}

	ai_frequency = 60
	ai_will_do = { 
		base = 5
		
		modifier = {
			has_trait = ambitious 
			add = 10
		}
		modifier = {
			has_trait = scholar 
			add = 10
		}
		modifier = {
			has_trait = witch 
			add = 10
		}
		modifier = {
			has_trait = ambitious 
			add = 10
		}
	}
	ai_targets = { 
		ai_recipients = courtiers 
		ai_recipients = guests 
		ai_recipients = family 
		ai_recipients = scripted_relations 
		max = 10 
	}
	ai_accept = {
		base = -50
		opinion_modifier = {
			who = scope:actor
			opinion_target = scope:recipient
			multiplier = 0.5
		}
		compatibility_modifier = {
			who = scope:actor
			compatibility_target = scope:recipient
			multiplier = 0.2
		}
		opinion_modifier = {
			who = scope:recipient
			opinion_target = scope:actor
			multiplier = 0.5
		}
		ai_value_modifier = {
			who = scope:recipient
			ai_honor = -0.25
			ai_compassion = 0
			ai_rationality = 0.25
			ai_greed = 0.5
			ai_sociability = 0.25
		}
	}
}

KoM_write_grimoire_interaction = {
	category = interaction_category_friendly
	icon = icon_scheme_crypto_religion
	desc = KoM_write_grimoire_interaction_desc

	cooldown = { years = 5 }

	is_shown = {
		scope:actor = scope:recipient
		scope:actor = { KoM_is_a_mage_trigger = yes }
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:goetia } } }
		flag = goetia
		localization = KoM_goetia
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:thaumaturgy } } }
		flag = thaumaturgy
		localization = KoM_thaumaturgy
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:theurgy } } }
		flag = theurgy
		localization = KoM_theurgy
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:alchemy } } }
		flag = alchemy
		localization = KoM_alchemy
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:taoism } } }
		flag = taoism
		localization = KoM_taoism
	}

	send_option = {
		is_shown = { scope:actor = { KoM_is_practitioner_of_magic_school_trigger = { SCHOOL = flag:onmyodo } } }
		flag = onmyodo
		localization = KoM_onmyodo
	}


	on_accept = {
		scope:actor = {
			save_scope_value_as = {
				name = random_max
				value = {
					value = 100
					switch = {
						trigger = yes
						scope:goetia = { value = KoM_goetia_xp }
						scope:thaumaturgy = { value = KoM_thaumaturgy_xp }
						scope:theurgy = { value = KoM_theurgy_xp }
						scope:alchemy = { value = KoM_alchemy_xp }
						scope:taoism = { value = KoM_taoism_xp }
						scope:onmyodo = { value = KoM_onmyodo_xp }
					}
				}
			}
			save_scope_value_as = {
				name = random_min
				value = {
					value = scope:random_max
					subtract = 40
					min = 0
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 1 } multiply = 0.95 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 2 } multiply = 0.90 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 3 } multiply = 0.85 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 4 } multiply = 0.8 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 5 } multiply = 0.75 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 6 } multiply = 0.7 }
				}
			}
			save_scope_value_as = {
				name = random_gain
				value = {
					value = learning
					divide = 10
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 1 } multiply = 1.1 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 2 } multiply = 1.2 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 3 } multiply = 1.3 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 4 } multiply = 1.4 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 5 } multiply = 1.5 }
					if = { limit = { KoM_has_hideout_building_trigger = { ID = hideout_building_library } scope:building.var:building_level = 6 } multiply = 1.6 }
					floor = yes
					max = 100
					min = 1
				}
			}
			custom_tooltip = KoM_write_grimoire_interaction_max
			custom_tooltip = KoM_write_grimoire_interaction_min
			custom_tooltip = KoM_write_grimoire_interaction_gain
			switch = {
				trigger = yes
				scope:goetia = { KoM_scavenge_hideout_building_hideout_building_library_effect = { SCHOOL = goetia } }
				scope:thaumaturgy = { KoM_scavenge_hideout_building_hideout_building_library_effect = { SCHOOL = thaumaturgy } }
				scope:theurgy = { KoM_scavenge_hideout_building_hideout_building_library_effect = { SCHOOL = theurgy } }
				scope:alchemy = { KoM_scavenge_hideout_building_hideout_building_library_effect = { SCHOOL = alchemy } }
				scope:taoism = { KoM_scavenge_hideout_building_hideout_building_library_effect = { SCHOOL = taoism } }
				scope:onmyodo = { KoM_scavenge_hideout_building_hideout_building_library_effect = { SCHOOL = onmyodo } }
			}
		}
	}

	auto_accept = yes

	ai_will_do = { base = 0 }
}

KoM_build_hideout_interaction = {
	category = interaction_category_friendly
	icon = icon_transfer_county
	desc = KoM_build_hideout_interaction_desc

	cooldown = { years = 25 }

	target_type = title
	target_filter = actor_realm_titles

	is_shown = {
		scope:actor = scope:recipient
		scope:actor = { KoM_is_a_mage_trigger = yes }
	}

	is_valid_showing_failures_only = {
		scope:actor = {
			gold >= 1250
		}
	}

	can_be_picked = {
		scope:target = {
			title_province = {
				NOT = { has_province_modifier = KoM_rumors_of_hideout_modifier }
			}
			tier <= tier_county
		}
	}

	on_accept = {
		scope:actor = {
			remove_short_term_gold = 1250
			KoM_hideout_create_empty_hideout_effect = { LOCATION = scope:target.title_province }
			hidden_effect_new_object = {
				KoM_hideout_change_owner_effect = { HIDEOUT = scope:temp_hideout NEW_OWNER = scope:actor }
			}
		}
	}

	auto_accept = yes

	ai_will_do = { base = 0 }
}