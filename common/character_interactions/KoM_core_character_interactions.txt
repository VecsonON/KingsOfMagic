KoM_study_grimoire_interaction = {
	category = interaction_category_friendly
	icon = icon_scheme_crypto_religion
	desc = KoM_study_grimoire_interaction_desc

	target_type = artifact
	target_filter = actor_artifacts

	ai_frequency = 60
	ai_will_do = {
		base = 1

		modifier = {
			add = 10
			scope:actor = { has_trait = scholar }
		}
		modifier = {
			add = 20
			scope:actor = { has_trait = witch }
		}
		modifier = {
			add = scope:actor.age
		}

		modifier = {
			add = -20
			scope:actor = { 
				faith = { has_doctrine_parameter = witchcraft_illegal }
				NOT = { has_trait = cynical }
			}
		}
		modifier = {
			add = -10
			scope:actor = { 
				faith = { has_doctrine_parameter = witchcraft_shunned }
				NOT = { has_trait = cynical }
			}
		}
	}
	ai_targets = { ai_recipients = self }

	# cooldown = { years = 2 }

	is_shown = {
		scope:actor = scope:recipient
		scope:actor = {
			any_character_artifact = {
				has_variable = KoM_grimoire
			}
		}
	}

	can_be_picked_artifact = {
		scope:target = {
			custom_tooltip = {
				text = KoM_study_grimoire_interaction_tt
				has_variable = KoM_grimoire
			}
		}
	}

	is_valid_showing_failures_only = {
		trigger_if = {
			limit = { exists = scope:target scope:target ?= { has_variable = KoM_grimoire } }
			scope:actor = {
				KoM_has_magic_school_xp_trigger = { SCHOOL = scope:target.var:KoM_grimoire VALUE = scope:target.var:max_mastery AT_LEAST = no } 
				KoM_has_magic_school_xp_trigger = { SCHOOL = scope:target.var:KoM_grimoire VALUE = scope:target.var:min_mastery AT_LEAST = yes }
			}
		}
	}

	on_accept = {
		scope:actor = {
			duel = {
				skill = learning
				value = 10
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = high_positive_duel_skill_multiplier
					}
					KoM_study_magic_school_effect = { SCHOOL = scope:target.var:KoM_grimoire COUNT = scope:target.var:mastery_gain }
				}
				50 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = low_negative_duel_skill_multiplier
					}
					add_stress = 25
				}
			}
			if = {
				limit = { 
					scope:target = { has_variable = gained_via_decision } 
					switch = {
						trigger = scope:target.var:KoM_grimoire
						flag:goetia = { has_variable = KoM_goetia_xp }
						flag:thaumaturgy = { has_variable = KoM_thaumaturgy_xp }
						flag:theurgy = { has_variable = KoM_theurgy_xp }
						flag:alchemy = { has_variable = KoM_alchemy_xp }
						flag:taoism = { has_variable = KoM_taoism_xp }
						flag:onmyodo = { has_variable = KoM_onmyodo_xp }
					}
					KoM_is_a_mage_trigger = yes
				}
				custom_tooltip = KoM_study_grimoire_interaction_warning
				hidden_effect = {
					random = {
						chance = 20
						send_interface_message = {
							title = KoM_study_grimoire_interaction
							switch = {
								trigger = scope:target.var:KoM_grimoire
								flag:goetia = {
									random_secret = {
										limit = { secret_type = KoM_secret_magus }
										expose_secret = scope:actor
									}
								}
								flag:thaumaturgy = {
									random_secret = {
										limit = { secret_type = KoM_secret_thaumaturge }
										expose_secret = scope:actor
									}
								}
								flag:theurgy = {
									random_secret = {
										limit = { secret_type = KoM_secret_theurgist }
										expose_secret = scope:actor
									}
								}
								flag:alchemy = {
									random_secret = {
										limit = { secret_type = KoM_secret_alchemist }
										expose_secret = scope:actor
									}
								}
								flag:taoism = {
									random_secret = {
										limit = { secret_type = KoM_secret_daoshi }
										expose_secret = scope:actor
									}
								}
								flag:onmyodo = {
									random_secret = {
										limit = { secret_type = KoM_secret_onmyoji }
										expose_secret = scope:actor
									}
								}
							}
						}
					}
				}
			}
		}
	}

	auto_accept = yes
}