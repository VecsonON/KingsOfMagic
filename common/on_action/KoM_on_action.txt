on_game_start = {
	on_actions = { PoM_on_game_start }
}

PoM_on_game_start = {
	events = {
		KoM_core_events.1
	}
	effect = {
		set_global_variable = {
			name = KoM_loaded
			value = yes
		}
		if = { limit = { has_global_variable = KoM_loaded } }
	}
}

yearly_global_pulse = {
	on_actions = { KoM_yearly_global_pulse }
}

KoM_yearly_global_pulse = {
	effect = {
		every_living_character = {
			limit = { has_variable = KoM_goetia_xp NOT = { any_secret = { secret_type = KoM_secret_magus } } }
			add_secret = { TYPE = KoM_secret_magus }
		}
		every_living_character = {
			limit = { has_variable = KoM_thaumaturgy_xp NOT = { any_secret = { secret_type = KoM_secret_thaumaturge } } }
			add_secret = { TYPE = KoM_secret_thaumaturge }
		}
		every_living_character = {
			limit = { has_variable = KoM_theurgy_xp NOT = { any_secret = { secret_type = KoM_secret_theurgist } } }
			add_secret = { TYPE = KoM_secret_theurgist }
		}
		every_living_character = {
			limit = { has_variable = KoM_alchemy_xp NOT = { any_secret = { secret_type = KoM_secret_alchemist } } }
			add_secret = { TYPE = KoM_secret_alchemist }
		}
		every_living_character = {
			limit = { has_variable = KoM_taoism_xp NOT = { any_secret = { secret_type = KoM_secret_daoshi } } }
			add_secret = { TYPE = KoM_secret_daoshi }
		}
		every_living_character = {
			limit = { has_variable = KoM_onmyodo_xp NOT = { any_secret = { secret_type = KoM_secret_onmyoji } } }
			add_secret = { TYPE = KoM_secret_onmyoji }
		}
	}
}

yearly_playable_pulse = {
	on_actions = { KoM_yearly_playable_pulse }
}

KoM_yearly_playable_pulse = {
	effect = {
		trigger_event = { on_action = KoM_quaterly_playable_pulse days =  45 }
		trigger_event = { on_action = KoM_quaterly_playable_pulse days = 135 }
		trigger_event = { on_action = KoM_quaterly_playable_pulse days = 225 }
		trigger_event = { on_action = KoM_quaterly_playable_pulse days = 315 }
	}
}
KoM_quaterly_playable_pulse = {
	effect = {
		trigger_event = { on_action = KoM_monthly_playable_pulse }
		trigger_event = { on_action = KoM_monthly_playable_pulse months = 1 }
		trigger_event = { on_action = KoM_monthly_playable_pulse months = 2 }
	}
}
KoM_monthly_playable_pulse = {
	effect = {
		if = { limit = { has_variable = current_rite } 
			var:current_rite = {
				change_variable = {
					name = total_progress
					add = {
						value = var:monthly_progress
						multiply = PREV.KoM_extra_rite_speed_mult
					}
				}
				if = { limit = { var:total_progress >= 100 } 
					PREV = { 
						trigger_event = { on_action = KoM_completed_rite } 
					}
				}
			}
		}
	}
}

on_death = {
	on_actions = { KoM_on_death }
}

KoM_on_death = {
	effect = {
		KoM_pass_saved_spells_effect = { HEIR = primary_heir }
		KoM_pass_alchemical_materials_effect = { HEIR = primary_heir }
	}
}

KoM_completed_rite = {
	effect = {
		switch = {
			trigger = var:current_rite.var:id
			flag:the_gate_of_invocation = { KoM_the_gate_of_invocation_effect = yes }
			flag:the_lesser_conjurations = { KoM_the_lesser_conjurations_effect = { TARGET = var:current_rite.var:target } }
			flag:the_seventy_two_gates = { KoM_the_seventy_two_gates_effect = { TARGET = var:current_rite.var:target } }
			flag:the_royal_theurgy_of_solomon = { KoM_the_royal_theurgy_of_solomon_effect = { TARGET = var:current_rite.var:target } }
			flag:the_great_work_of_unification = { KoM_the_great_work_of_unification_effect = { TARGET = var:current_rite.var:target DEMON = var:current_rite.var:demon } }
			
			flag:thaumaturgy_spell_creation = { 
				KoM_add_spell_to_list_effect = { SPELL = var:current_rite.var:spell } 
				trigger_event = { on_action = KoM_after_rite }
			}
			
			flag:the_initiate_of_purification = { KoM_the_initiate_of_purification_effect = yes }
			flag:the_invoker_of_powers = { KoM_the_invoker_of_powers_effect = yes }
			flag:the_walker_between_spheres = { KoM_the_walker_between_spheres_effect = yes }
			flag:the_hierophant_of_fire = { KoM_the_hierophant_of_fire_effect = yes }
			flag:the_theios_anthropos = { KoM_the_theios_anthropos_effect = yes }
			
			flag:elixir_of_the_white_rose = { KoM_elixir_of_the_white_rose_effect = yes }
			flag:draught_of_still_waters = { KoM_draught_of_still_waters_effect = yes }
			flag:infusion_of_lead = { KoM_infusion_of_lead_effect = yes }
			flag:elixir_of_ash_and_salt = { KoM_elixir_of_ash_and_salt_effect = yes }
			flag:dew_of_morning_stars = { KoM_dew_of_morning_stars_effect = yes }
			flag:aqua_sapientiae = { KoM_aqua_sapientiae_effect = yes }
			flag:elixir_of_the_solar_mind = { KoM_elixir_of_the_solar_mind_effect = yes }
			flag:draught_of_the_inner_flame = { KoM_draught_of_the_inner_flame_effect = yes }
			flag:tears_of_the_red_king = { KoM_tears_of_the_red_king_effect = yes }
			flag:blood_of_the_phoenix = { KoM_blood_of_the_phoenix_effect = yes }
			flag:elixir_rubedo = { KoM_elixir_rubedo_effect = yes }
			flag:homunculi = { KoM_homunculi_effect = yes }
			flag:elixir_vitae = { KoM_elixir_vitae_effect = yes }
			flag:aurum_astralis = { KoM_aurum_astralis_effect = yes }
			flag:the_philosophers_stone = { KoM_the_philosophers_stone_effect = yes }

			flag:the_neidan_meditation = { KoM_the_neidan_meditation_effect = yes }
			flag:qingqiu_huifu_yishi = { KoM_qingqiu_huifu_yishi_effect = { TARGET = var:current_rite.var:target } }
			flag:qiqiu_pingjing_xinling_de_yishi = { KoM_qiqiu_pingjing_xinling_de_yishi_effect = { TARGET = var:current_rite.var:target } }
			flag:qifu_yishi = { KoM_qifu_yishi_effect = { TARGET = var:current_rite.var:target } }
			flag:qiqiu_mingri_zhishi_de_yishi = { KoM_qiqiu_mingri_zhishi_de_yishi_effect = { TARGET = var:current_rite.var:target } }
			flag:qingqiu_kuaisu_luxing_de_yishi = { KoM_qingqiu_kuaisu_luxing_de_yishi_effect = yes }
		}
	}
}

KoM_after_rite = {
	effect = {
		ALT_delete_rite_effect = { RITE = var:current_rite }
	}
}

on_artifact_changed_owner = {
	on_actions = { KoM_on_artifact_changed_owner }
}

KoM_on_artifact_changed_owner = {
	effect = {
		if = {
			limit = { NOT = { var:gained_via_decision ?= THIS } }
			remove_variable = gained_via_decision
		}
	}
}

KoM_thaumaturgy_calculate_difficulty = {
	effect = {
		save_scope_value_as = {
			name = difficulty
			value = {
				value = 1
				every_in_list = {
					variable = spell_actions
					switch = {
						trigger = var:action_name
						flag:recuperare = { add = 1 }
						flag:claritudo = { add = 2 }
						flag:sarcio = { add = 3 }
						flag:damnum = { add = 3 }
						flag:celeritas = { add = 3 }
						flag:fortitudo = { add = 4 }
						flag:stabilitas = { add = 4 }
						flag:opinio = { add = 5 }
						flag:anima = { add = 5 }
						flag:scientia = { add = 5 }
						flag:melius = { add = 10 }
						flag:peius = { add = 10 }

						flag:duo = { add = 5 }
						flag:tres = { add = 15 }
					}
				}
				switch = {
					trigger = var:confirmation
					flag:voluntas = { multiply = 0.8 }
					flag:nuntius = { multiply = 1 }
					flag:angelus = { multiply = 1.25 }
					flag:deus = { multiply = 1.5 }
				}
			}
		}
		set_variable = { name = spell_difficulty value = scope:difficulty }
	}
}

KoM_alchemy_material_refresh = {
	effect = {
		remove_variable = KoM_alchemic_materials_refresh
		clear_variable_list = KoM_alchemic_materials
		remove_variable = KoM_alchemic_materials_salt_num
		remove_variable = KoM_alchemic_materials_charcoal_num
		remove_variable = KoM_alchemic_materials_honey_num
		remove_variable = KoM_alchemic_materials_lead_num
		remove_variable = KoM_alchemic_materials_silver_num
		remove_variable = KoM_alchemic_materials_crushed_crystals_num
		remove_variable = KoM_alchemic_materials_human_blood_num
		remove_variable = KoM_alchemic_materials_vulcanic_ash_num
		remove_variable = KoM_alchemic_materials_fireflower_num
	}
}